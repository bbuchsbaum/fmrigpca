% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit.R
\name{fit_subject_genpca}
\alias{fit_subject_genpca}
\title{Fit generalized PCA across multiple runs (voxel level)}
\usage{
fit_subject_genpca(
  nv_list,
  mask_vol,
  gm_vol,
  wm_vol,
  csf_vol,
  FD_list = NULL,
  DVARS_list = NULL,
  k = 20,
  p_ar = 1L,
  lambda_s = 0.5,
  lambda_t = 0.3,
  lap_k = 6,
  lap_sigma = 2.5
)
}
\arguments{
\item{nv_list}{List of \code{NeuroVec} runs.}

\item{mask_vol}{\code{NeuroVol} binary mask.}

\item{gm_vol, wm_vol, csf_vol}{\code{NeuroVol} tissue probability maps (same space as mask).}

\item{FD_list, DVARS_list}{Optional lists of per-run motion metrics.
Each list should contain numeric vectors with one element per list
corresponding to each run in nv_list. FD is framewise displacement (mm)
and DVARS is the temporal derivative of signal variance. These metrics
are used to down-weight high-motion frames. See \code{\link{make_frame_weights}}
for detailed definitions.}

\item{k}{Number of components to fit (default 20). Start with modest values
(5-10) for exploration, increase based on rank selection diagnostics.}

\item{p_ar}{AR order for row whitener (default 1). Use 0 to skip AR modeling,
higher values (2-3) for data with stronger temporal autocorrelation.}

\item{lambda_s}{Spatial regularization weight (default 0.5). Controls smoothness
via the graph Laplacian; higher values enforce more spatial coherence.}

\item{lambda_t}{Temporal regularization weight (default 0.3). Controls temporal
smoothness; higher values penalize rapid fluctuations.}

\item{lap_k}{Number of nearest neighbors for Laplacian construction (default 6).
Typically 6-8 for 3D connectivity; higher values increase spatial coupling.}

\item{lap_sigma}{Gaussian kernel bandwidth for edge weights (default 2.5).
Controls the decay of spatial influence with distance.}
}
\value{
A \code{genpca} object with loadings \code{v} and added \code{scores} (stacked time x k).
}
\description{
Builds a voxel-level column metric \code{A} and per-run row metrics \code{M_r}, stacks
runs in time, and fits \code{genpca} with \code{A} and block-diagonal \code{M}. Adds
\code{scores} (projected time scores) for convenience.
}
\details{
Validates that all \code{NeuroVec} runs share the same spatial \code{NeuroSpace} as the
mask and tissue maps. Constructs a Laplacian \code{L} via \code{make_laplacian}, a
tissue/tSNR-weighted \code{A} via \code{build_spatial_metric}, and per-run \code{M_r} via
\code{make_M_for_run} using optional FD/DVARS. Rows (time) are stacked across runs
and \code{genpca::genpca} is called with \code{ncomp = k}. The result gains a \code{scores}
component via \code{multivarious::scores}.
}
\examples{
\dontrun{
fit <- fit_subject_genpca(nv_list, mask, gm, wm, csf, k = 5)
}

}
\seealso{
\code{\link[=fit_subject_genpca_parcel]{fit_subject_genpca_parcel()}} for parcel-level analysis,
\code{\link[=fit_subject_metapca]{fit_subject_metapca()}} for combining multiple fits

Other main fitting: 
\code{\link{fit_subject_genpca_parcel}()},
\code{\link{fit_subject_metapca}()}
}
\concept{main fitting}
